<!DOCTYPE html>
<meta charset="utf-8">
<div style="width: 1000px">
  <a href="#A" class="graph-link" title="General Works">A</a>
  <a href="#B" class="graph-link" title="Philosophy, Psychology, Religion">B</a>
  <a href="#C" class="graph-link" title="Auxiliary Sciences of History (General)">C</a>
  <a href="#D" class="graph-link" title="World History (except American History)">D</a>
  <a href="#E" class="graph-link" title="American History">E</a>
  <a href="#F" class="graph-link" title="Local History of the United States and British, Dutch, French, and Latin America">F</a>
  <a href="#G" class="graph-link" title="Geography, Anthropology, Recreation">G</a>
  <a href="#H" class="graph-link" title="Social Sciences">H</a>
  <a href="#J" class="graph-link" title="Political Science">J</a>
  <a href="#K" class="graph-link" title="Law">K</a>
  <a href="#L" class="graph-link" title="Education">L</a>
  <a href="#M" class="graph-link" title="Music">M</a>
  <a href="#N" class="graph-link" title="Fine Arts">N</a>
  <a href="#P" class="graph-link" title="Language and Literature">P</a>
  <a href="#Q" class="graph-link" title="Science">Q</a>
  <a href="#R" class="graph-link" title="Medicine">R</a>
  <a href="#S" class="graph-link" title="Agriculture">S</a>
  <a href="#T" class="graph-link" title="Technology">T</a>
  <a href="#U" class="graph-link" title="Military Science">U</a>
  <a href="#V" class="graph-link" title="Naval Science">V</a>
  <a href="#Z" class="graph-link" title="Bibliography, Library Science">Z</a>

  <div style="float: right"><button id="zoom-out">Zoom Out</button></div>
</div>
<canvas width="1000" height="1000"></canvas>

<script src="https://d3js.org/d3.v4.min.js"></script>
<style> /* set the CSS */

div.tooltip {
  position: absolute;
  text-align: center;
  padding: 2px;
  font: 12px sans-serif;
  background: lightsteelblue;
  border: 0px;
  border-radius: 8px;
}

</style>

<script>

var el = document.getElementsByClassName('graph-link');
for (var i=0;i<el.length; i++) {
    el[i].addEventListener('click',function (element){
      window.location = '#'+element.target.innerHTML
      location.reload()
    })
}

var level = 'A'
if (window.location.href.split('#')[1]){
  level = window.location.href.split('#')[1].toUpperCase()
}


var canvas = document.querySelector("canvas"),
    context = canvas.getContext("2d"),
    width = canvas.width,
    height = canvas.height;



d3.json("data/" + level + ".json", function(error, graph) {
  if (error) throw error;


  // var canvas = d3.select("canvas").call(d3.zoom().scaleExtent([1, 8]).on("zoom", zoom)),
  //     context = canvas.node().getContext("2d"),
  //     width = canvas.property("width"),
  //     height = canvas.property("height");


  // function zoom() {
  //   var transform = d3.event.transform;
  //   context.save();
  //   context.clearRect(0, 0, width, height);
  //   context.translate(transform.x, transform.y);
  //   context.scale(transform.k, transform.k);
  //   ticked();
  //   context.restore();
  // }


  var simulation = d3.forceSimulation()
      .force("link", d3.forceLink().id(function(d) { return d.id; }))
      .force("charge", d3.forceManyBody().strength(-1200).distanceMax(300))
      .force('repulsion', d3.forceManyBody().strength(-500).distanceMax(100))
      .force("center", d3.forceCenter(width / 2, height / 2));


  var div = d3.select("body").append("div")
      .attr("class", "tooltip")
      .style("opacity", 0);

  var zoom = false;
  var zoomFactor = 1;


  // canvas.on('mouseout', function(){console.log('')});
  document.querySelector("#zoom-out").addEventListener('click',function (element){
      zoom = true
      zoomFactor = zoomFactor - 0.25
      ticked()
    })

  document.querySelector("canvas").onmouseout = function(event) {
    div.transition().style("opacity", 0);

  }

  var myScale = d3.scaleLinear()
    .domain([0, graph.maxCount])
    .range([5, 75]);

  simulation
      .nodes(graph.nodes)
      .on("tick", ticked);

  simulation.force("link")
      .links(graph.links);

  d3.select(canvas)
      .call(d3.drag()
          .container(canvas)
          .subject(dragsubject)
          .on("start", dragstarted)
          .on("drag", dragged)
          .on("end", dragended));

  function ticked() {

    context.save();
    context.clearRect(0, 0, width, height);

    // context.transform(0.5, 0.5)
    if (zoom){
      context.scale(zoomFactor, zoomFactor)
      context.translate(width / 2, height / 2);
    }

    context.beginPath();
    graph.links.forEach(drawLink);
    context.strokeStyle = "#aaa";
    context.stroke();

    context.beginPath();
    graph.nodes.forEach(drawNode);

    context.fill();
    context.strokeStyle = "#fff";
    context.stroke();

    if(closeNode){
      // console.log(closeNode)
       div.transition()
         .duration(100)
         .style("opacity", .9);
       div .html(
         closeNode.subject + ', ' + closeNode.size)     
         .style("left", (closeNode.x) + "px")             
         .style("top", (closeNode.y - 28) + "px");


    }



    context.restore();
  }


  var closeNode;
  d3.select("canvas").on("mousemove", function(d){
    var p = d3.mouse(this);
    closeNode = simulation.find(p[0], p[1]);
    ticked();
  })



  function dragsubject() {
    return simulation.find(d3.event.x, d3.event.y);
  }


  function dragstarted() {
    if (!d3.event.active) simulation.alphaTarget(0.3).restart();
    d3.event.subject.fx = d3.event.subject.x;
    d3.event.subject.fy = d3.event.subject.y;
  }

  function dragged() {
    d3.event.subject.fx = d3.event.x;
    d3.event.subject.fy = d3.event.y;
  }

  function dragended() {
    if (!d3.event.active) simulation.alphaTarget(0);

    // d3.event.subject.fx = null;
    // d3.event.subject.fy = null;
  }

  function drawLink(d) {
    context.moveTo(d.source.x, d.source.y);
    context.lineTo(d.target.x, d.target.y);
  }

  function drawNode(d) {

    if (d.id.length===1){
      d.fx = width / 2
      d.fy = height / 2
      context.fillStyle = "red";
    }else{
      context.fillStyle = "black";
    }


    var size = parseInt(myScale(d.size))
    context.moveTo(d.x + size, d.y);
    context.arc(d.x, d.y, size, 0, 2 * Math.PI);
  }




});


</script>